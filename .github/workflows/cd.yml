name: Deploy to EC2

on:
  workflow_run:
    workflows: [ "Java CI with Gradle" ]
    types: [ completed ]
    branches: [ "dev" ]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    env:
      # GitHub Actions SecretsÏóê ÎØ∏Î¶¨ Îì±Î°ùÌï¥ Îëî PAT
      SUBMODULE_TOKEN: ${{ secrets.SUBMODULE_TOKEN }}

    steps:
      # 1) ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ ‚Äì Í∑∏ÎåÄÎ°ú
      - name: Checkout code
        uses: actions/checkout@v4

      # 2) SSH ÌÇ§ Ï§ÄÎπÑ ‚Äì Í∑∏ÎåÄÎ°ú
      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 600 key.pem

      # 3) EC2 Î∞∞Ìè¨
      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "bash -s" -- "${{ secrets.SUBMODULE_TOKEN }}" << 'EOF'
            SUBMODULE_TOKEN="$1"
            set -e
        
            cd ~/UhDyL-Backend
            echo ">>> SUBMODULE_TOKEN is '\${SUBMODULE_TOKEN:0:5}...' (masked)"
            git remote set-url origin \
            https://\${SUBMODULE_TOKEN}@github.com/UhDyL/UhDyL-Backend.git
            git pull origin dev
        
            git config submodule.src/main/resources/security.url \
            https://\${SUBMODULE_TOKEN}@github.com/UhDyL/UhDyL-Security.git
            git submodule sync
            git submodule update --init --recursive --depth 1

          
            ./gradlew clean build -x test          

            # Java 17/21 Î∞îÏù¥ÎÑàÎ¶¨Ïóê 443 Î∞îÏù∏Îî© Í∂åÌïú Î∂ÄÏó¨ ‚Äï ÏµúÏ¥à 1ÌöåÎ©¥ Ï°±Ìï®
            sudo setcap 'cap_net_bind_service=+ep' \
                 $(readlink -f $(which java)) || true

            pkill -f 'UhDyL-Backend-0.0.1-SNAPSHOT.jar' || true

            echo "üîç ÏÑúÎ≤Ñ ÏÇ¨Ï†Ñ Ïã§Ìñâ ÌÖåÏä§Ìä∏..."
            # ÏûÑÏãú ÎûúÎç§ Ìè¨Ìä∏(0)Î°ú Í∏∞ÎèôÌï¥ 443 Ï∂©Îèå Î∞©ÏßÄ + Î°úÍ∑∏ Ï≤¥ÌÅ¨
            java -jar build/libs/UhDyL-Backend-0.0.1-SNAPSHOT.jar \
                 --spring.profiles.active=dev \
                 --server.port=0 > /tmp/test.log 2>&1 &
            sleep 10

            if grep -Ei 'Exception|ERROR' /tmp/test.log; then
              echo '‚ùå ÏÑúÎ≤Ñ Ïã§Ìñâ Ï§ë ÏóêÎü¨ Î∞úÏÉù!'
              cat /tmp/test.log
              exit 1
            fi

            echo "‚úÖ ÏÇ¨Ï†Ñ Ïã§Ìñâ ÏÑ±Í≥µ ‚Üí Î≥∏ Ïã§Ìñâ"
            pkill -f 'UhDyL-Backend-0.0.1-SNAPSHOT.jar' || true

            nohup java -jar build/libs/UhDyL-Backend-0.0.1-SNAPSHOT.jar \
                 --spring.profiles.active=dev \
                 > nohup.out 2>&1 &
          EOF
